<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>以图搜图架构优化：使用客户端模型提取图像特征 - 凌虚 Blog</title><meta name=Description content="以图搜图架构优化：使用客户端模型提取图像特征"><meta property="og:url" content="https://rifewang.github.io/image-search-use-client-model/">
<meta property="og:site_name" content="凌虚 Blog"><meta property="og:title" content="以图搜图架构优化：使用客户端模型提取图像特征"><meta property="og:description" content="以图搜图架构优化：使用客户端模型提取图像特征"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-04T14:44:38+08:00"><meta property="article:modified_time" content="2024-07-04T16:31:57+08:00"><meta property="article:tag" content="Engineering"><meta property="og:image" content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:title content="以图搜图架构优化：使用客户端模型提取图像特征"><meta name=twitter:description content="以图搜图架构优化：使用客户端模型提取图像特征"><meta name=application-name content="凌虚的博客"><meta name=apple-mobile-web-app-title content="凌虚的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://rifewang.github.io/image-search-use-client-model/><link rel=prev href=https://rifewang.github.io/k8s-custom-scheduler/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"以图搜图架构优化：使用客户端模型提取图像特征","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rifewang.github.io\/image-search-use-client-model\/"},"image":["https:\/\/rifewang.github.io\/images\/avatar.png"],"genre":"posts","keywords":"Engineering","wordcount":1386,"url":"https:\/\/rifewang.github.io\/image-search-use-client-model\/","datePublished":"2024-07-04T14:44:38+08:00","dateModified":"2024-07-04T16:31:57+08:00","license":"Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)","publisher":{"@type":"Organization","name":"凌虚","logo":"https:\/\/rifewang.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"凌虚"},"description":"以图搜图架构优化：使用客户端模型提取图像特征"}</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-VRMQFEVL7J"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VRMQFEVL7J")</script><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about>作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about title>作者</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">以图搜图架构优化：使用客户端模型提取图像特征</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>凌虚</a></span>&nbsp;<span class=post-category>included in <a href=/categories/engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Engineering</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-07-04>2024-07-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1386 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;3 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#序言>序言</a></li><li><a href=#系统架构>系统架构</a></li><li><a href=#使用客户端模型优化架构>使用客户端模型优化架构</a></li><li><a href=#客户端模型的可行性和约束>客户端模型的可行性和约束</a><ul><li><a href=#示例>示例</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=序言>序言</h2><p>以图搜图系统指的是从图像内容提取特征向量，然后使用向量数据库进行向量数据的插入、删除、相似性检索等操作，进而提供根据图像内容搜索出具有相似内容的其它图像的功能。</p><h2 id=系统架构>系统架构</h2><p>典型的搜图系统整体架构时序图如下：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch.png data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch.png, https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch.png 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch.png title=https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch.png></p><p>图像上传过程：</p><ol><li>客户端上传图像到服务端。</li><li>服务端存储图像至对象存储、插入结构化数据至关系型数据库、发送消息至 MQ 消息队列。</li><li>服务端对客户端请求返回响应。</li><li>图像搜索服务接受 MQ 的消息，下载图像内容，使用特定模型提取图像特征向量，然后将特征向量插入到向量数据库。</li></ol><p>这里使用 MQ 的主要原因有：</p><ul><li>异步快速响应，因为提取图像特征比较耗时，如果是同步的过程则会对客户端体验不友好。</li><li>解耦服务、服务异构，提取图像特征属于计算机视觉领域，编程语言生态基本是 Python ，而后端服务则常见于 Java、Golang、Node.js 等，这在架构上就要求服务异构和解耦。</li><li>削峰填谷，由于用户上传图像具有波峰波谷的天然特性，使用 MQ 可以使下游图像计算保持平稳。</li></ul><p>图像搜索过程：</p><ol><li>客户端上传图像到服务端。</li><li>服务端发起调用并将图像传递到图像搜索服务，图像搜索服务提取图像特征向量，然后查询向量数据库进行相似性搜索，最后返回向量搜索结果。</li><li>服务端根据向量搜索结果查询结构化数据，整合数据，最后响应。</li></ol><p>我们可以看到以上系统中，比较耗时的有两部分：</p><ol><li>图像传递链路长：客户端 -> 服务端 -> 对象存储 -> 图像搜索服务。</li><li>图像特征计算比较耗时、且比较消耗服务器资源。</li></ol><h2 id=使用客户端模型优化架构>使用客户端模型优化架构</h2><p>为了进一步优化系统架构，我们可以尝试使用客户端模型进行图像特征提取。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch-client-model.png data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch-client-model.png, https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch-client-model.png 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch-client-model.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch-client-model.png title=https://raw.githubusercontent.com/RifeWang/images/master/engineering/image-search-system-arch-client-model.png></p><p>图像上传过程：</p><ol><li>客户端向服务端请求对象存储的直传地址，然后客户端直接将图像内容传递到对象存储（需要对象存储支持直传操作）。</li><li>客户端进行本地计算，提取图像特征向量，然后传递特征向量和结构化数据给服务端。</li><li>服务端对结构化数据和向量数据分别插入到不同的数据库，完成响应。</li></ol><p>图像搜索过程：</p><ol><li>客户端进行本地计算，提取图像特征向量，然后传递特征向量和结构化数据给服务端。</li><li>服务端分别进行向量检索和结构化数据查询，整合数据，完成响应。</li></ol><p>优化后的架构：</p><ul><li>图像传递链路短，只有客户端 -> 对象存储。</li><li>图像特征计算卸载到了客户端完成，服务器不需要再消耗计算资源。</li><li>减少了 MQ 和图像搜索服务这两个构件，架构更加简单、复杂度降低。</li></ul><h2 id=客户端模型的可行性和约束>客户端模型的可行性和约束</h2><p>客户端相比于服务端具有硬件资源有限、且不可扩展的特点，因此这就要求客户端使用的模型要更小、计算消耗更少。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/engineering/keras-models.jpg data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/engineering/keras-models.jpg, https://raw.githubusercontent.com/RifeWang/images/master/engineering/keras-models.jpg 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/engineering/keras-models.jpg 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/engineering/keras-models.jpg title=https://raw.githubusercontent.com/RifeWang/images/master/engineering/keras-models.jpg></p><p>我们根据上图中的模型对比可以看到 mobilenet 这种模型更符合我们的需求（模型的名字就能看出来）。</p><h3 id=示例>示例</h3><p>以下给出一个前端使用 mobilenet 完成图像特征提取的示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE html&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.jsdelivr.net/npm/@tensorflow/tfjs&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;file&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;imageInput&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onclick</span><span class=o>=</span><span class=s>&#34;extractFeatures()&#34;</span><span class=p>&gt;</span>Extract Features<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>pre</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;result&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>pre</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>async</span> <span class=kd>function</span> <span class=nx>loadModel</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>model</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 加载模型时 mobilenet 会去 storage.googleapis.com 下载
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>model</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>mobilenet</span><span class=p>.</span><span class=nx>load</span><span class=p>({</span><span class=nx>version</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span> <span class=nx>alpha</span><span class=o>:</span> <span class=mf>1.0</span><span class=p>});</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>model</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>function</span> <span class=nx>preprocessImage</span><span class=p>(</span><span class=nx>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>tensor</span> <span class=o>=</span> <span class=nx>tf</span><span class=p>.</span><span class=nx>browser</span><span class=p>.</span><span class=nx>fromPixels</span><span class=p>(</span><span class=nx>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=nx>resizeNearestNeighbor</span><span class=p>([</span><span class=mi>224</span><span class=p>,</span> <span class=mi>224</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=nx>toFloat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>.</span><span class=nx>expandDims</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>tensor</span><span class=p>.</span><span class=nx>div</span><span class=p>(</span><span class=mf>255.0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kr>async</span> <span class=kd>function</span> <span class=nx>extractFeatures</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>input</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;imageInput&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>input</span><span class=p>.</span><span class=nx>files</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>alert</span><span class=p>(</span><span class=s1>&#39;Please select an image file first.&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>model</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>loadModel</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>timeStart</span> <span class=o>=</span> <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>file</span> <span class=o>=</span> <span class=nx>input</span><span class=p>.</span><span class=nx>files</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FileReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=nx>reader</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>image</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Image</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=nx>image</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nx>image</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kr>async</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>processedImage</span> <span class=o>=</span> <span class=nx>preprocessImage</span><span class=p>(</span><span class=nx>image</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>features</span> <span class=o>=</span> <span class=nx>model</span><span class=p>.</span><span class=nx>infer</span><span class=p>(</span><span class=nx>processedImage</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span> <span class=c1>// 去掉最后的全连接层
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=kr>const</span> <span class=nx>featuresArray</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>features</span><span class=p>.</span><span class=nx>array</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                    <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s1>&#39;result&#39;</span><span class=p>).</span><span class=nx>textContent</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>featuresArray</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Extract feature spend: </span><span class=si>${</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>-</span> <span class=nx>timeStart</span><span class=si>}</span><span class=sb> ms`</span><span class=p>);;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>reader</span><span class=p>.</span><span class=nx>readAsDataURL</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后在我的笔记本电脑简单测试的结果：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/engineering/mobilenet-test.png data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/engineering/mobilenet-test.png, https://raw.githubusercontent.com/RifeWang/images/master/engineering/mobilenet-test.png 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/engineering/mobilenet-test.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/engineering/mobilenet-test.png title=https://raw.githubusercontent.com/RifeWang/images/master/engineering/mobilenet-test.png></p><p>从上图可以看到，在我的客户端处理一张图像可以在一秒内完成，当然实际耗时取决于硬件资源和图像大小。</p><p>最后，如果你对此类主题感兴趣，可以阅读我的<a href=https://lingxu.pages.dev/categories/engineering/ target=_blank rel="noopener noreffer">其它相关文章</a>。</p><hr><p>参考资料：</p><ul><li><em><a href=https://keras.io/api/applications/ target=_blank rel="noopener noreffer">https://keras.io/api/applications/</a></em></li><li><em><a href=https://www.tensorflow.org/js/models target=_blank rel="noopener noreffer">https://www.tensorflow.org/js/models</a></em></li><li><em><a href=https://github.com/tensorflow/tfjs-models/tree/master/mobilenet target=_blank rel="noopener noreffer">https://github.com/tensorflow/tfjs-models/tree/master/mobilenet</a></em></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-07-04</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://rifewang.github.io/image-search-use-client-model/ data-title=以图搜图架构优化：使用客户端模型提取图像特征 data-hashtags=Engineering><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://rifewang.github.io/image-search-use-client-model/ data-hashtag=Engineering><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://rifewang.github.io/image-search-use-client-model/ data-title=以图搜图架构优化：使用客户端模型提取图像特征><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://rifewang.github.io/image-search-use-client-model/ data-title=以图搜图架构优化：使用客户端模型提取图像特征><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://rifewang.github.io/image-search-use-client-model/ data-title=以图搜图架构优化：使用客户端模型提取图像特征><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/engineering/>Engineering</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/k8s-custom-scheduler/ class=prev rel=prev title="Kubernetes scheduler 概述及自定义调度器"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Kubernetes scheduler 概述及自定义调度器</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>凌虚</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>