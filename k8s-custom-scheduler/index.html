<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Kubernetes scheduler 概述及自定义调度器 - 凌虚 Blog</title><meta name=Description content="Kubernetes scheduler 概述及自定义调度器"><meta property="og:url" content="https://rifewang.github.io/k8s-custom-scheduler/">
<meta property="og:site_name" content="凌虚 Blog"><meta property="og:title" content="Kubernetes scheduler 概述及自定义调度器"><meta property="og:description" content="Kubernetes scheduler 概述及自定义调度器"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-15T20:04:06+08:00"><meta property="article:modified_time" content="2024-06-15T21:56:43+08:00"><meta property="article:tag" content="Kubernetes"><meta property="og:image" content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:title content="Kubernetes scheduler 概述及自定义调度器"><meta name=twitter:description content="Kubernetes scheduler 概述及自定义调度器"><meta name=application-name content="凌虚的博客"><meta name=apple-mobile-web-app-title content="凌虚的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://rifewang.github.io/k8s-custom-scheduler/><link rel=prev href=https://rifewang.github.io/k8s-service-long-lived-connection/><link rel=next href=https://rifewang.github.io/image-search-use-client-model/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Kubernetes scheduler 概述及自定义调度器","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rifewang.github.io\/k8s-custom-scheduler\/"},"image":["https:\/\/rifewang.github.io\/images\/avatar.png"],"genre":"posts","keywords":"Kubernetes","wordcount":1899,"url":"https:\/\/rifewang.github.io\/k8s-custom-scheduler\/","datePublished":"2024-06-15T20:04:06+08:00","dateModified":"2024-06-15T21:56:43+08:00","license":"Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)","publisher":{"@type":"Organization","name":"凌虚","logo":"https:\/\/rifewang.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"凌虚"},"description":"Kubernetes scheduler 概述及自定义调度器"}</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-VRMQFEVL7J"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VRMQFEVL7J")</script><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about>作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about title>作者</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kubernetes scheduler 概述及自定义调度器</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>凌虚</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>Kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-06-15>2024-06-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1899 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#kube-scheduler>kube-scheduler</a><ul><li><a href=#扩展点和默认插件>扩展点和默认插件</a></li></ul></li><li><a href=#自定义调度器>自定义调度器</a><ul><li><a href=#自定义调度器示例>自定义调度器示例</a><ul><li><a href=#配置-kubeschedulerconfiguration>配置 <code>KubeSchedulerConfiguration</code></a></li><li><a href=#部署-deployment-应用-kube-scheduler>部署 Deployment 应用 kube-scheduler</a></li><li><a href=#验证>验证</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=kube-scheduler>kube-scheduler</h2><p><code>kube-scheduler</code> 是 k8s 集群中控制平面的一个重要组件，其负责的工作简单且专一：给未分配的 pod 分配一个 node 节点。</p><p>调度器的大致工作过程可以分为以下几步：</p><ul><li>监听到未绑定 node 的 pod。</li><li>过滤节点：挑选出来适合分配这个 pod 的 node 节点（可能有多个）。</li><li>节点打分：给过滤出来的节点进行打分。</li><li>最后选择得分最高的那个 node 与 pod 绑定（如果最高得分有多个 node 则随机选择一个）。</li></ul><p>更加详细的步骤则参考下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduling-framework-extensions.png data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduling-framework-extensions.png, https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduling-framework-extensions.png 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduling-framework-extensions.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduling-framework-extensions.png title=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduling-framework-extensions.png></p><h3 id=扩展点和默认插件>扩展点和默认插件</h3><p>扩展点：调度器内部的工作流程划分为了一系列的步骤，为了满足可扩展性，某些步骤被设计成了扩展点，用户可以自己编码实现接口插入到这些扩展点，从而实现自定义调度器。</p><p>默认插件：Kubernetes 已经定义好了很多默认插件，这些插件实现了一个或者多个扩展点，默认调度器就是由这些默认插件组合而成。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-point-plugin.png data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-point-plugin.png, https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-point-plugin.png 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-point-plugin.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-point-plugin.png title=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-point-plugin.png></p><p>如上图所示，蓝色部分是扩展点，绿色部分是默认插件。</p><p>扩展点是按照顺序依次执行的，每个插件可以作用于一个或者多个扩展点。</p><p>调度通过以下扩展点的一系列阶段进行：</p><ul><li><code>queueSort</code>: 这些插件提供排序功能，用于对调度队列中的待处理 Pod 进行排序。每次只能启用一个队列排序插件。</li><li><code>preFilter</code>: 这些插件用于在过滤之前预处理或检查有关 Pod 或集群的信息。它们可以将 Pod 标记为不可调度。</li><li><code>filter</code>: 这些插件相当于调度策略中的谓词，用于过滤无法运行 Pod 的节点。过滤插件按配置的顺序调用。如果没有节点通过所有过滤器，Pod 将被标记为不可调度。</li><li><code>postFilter</code>: 当没有找到可行节点来调度 Pod 时，这些插件按配置顺序被调用。如果任何 postFilter 插件将 Pod 标记为可调度，则不会调用剩余插件。</li><li><code>preScore</code>: 这是一个信息性扩展点，可用于在评分之前进行工作。</li><li><code>score</code>: 这些插件为通过过滤阶段的每个节点提供一个分数，然后调度器会选择得分总和最高的节点。</li><li><code>reserve</code>: 这是一个信息性扩展点，通知插件何时为特定 Pod 保留了资源。插件还实现一个 Unreserve 调用，如果在保留期间或之后发生失败，将调用该函数。</li><li><code>permit</code>: 这些插件可以阻止或延迟 Pod 的绑定。</li><li><code>preBind</code>: 这些插件执行 Pod 绑定前所需的任何工作。</li><li><code>bind</code>: 这些插件将 Pod 绑定到节点。绑定插件按顺序调用，一旦其中一个完成绑定，剩余插件将被跳过。至少需要一个绑定插件。</li><li><code>postBind</code>: 这是一个信息性扩展点，在 Pod 绑定后调用。</li></ul><p>默认插件非常多，不过你看它的名字就知道它们干了啥，本文不多赘述。</p><h2 id=自定义调度器>自定义调度器</h2><p>根据是否编写代码，我把自定义调度器的方式分为了两种：</p><ul><li>不写代码，调整组合已有的默认插件，从而定义新的调度器。</li><li>实现接口代码，然后定义调度器。</li></ul><p>本文将会描述第一种方式，通过调整默认插件的方式快速定义一个新的调度器。</p><h3 id=自定义调度器示例>自定义调度器示例</h3><p>默认插件 <code>NodeResourcesFit</code> 有三种评分策略：<code>LeastAllocated</code>(默认)、<code>MostAllocated</code> 和 <code>RequestedToCapacityRatio</code>，这三种策略的目的分别是优先选择资源使用率最低的节点、优先选择资源使用率较高的节点从而最大化节点资源使用率、以及平衡节点的资源使用率。</p><p>默认插件 <code>VolumeBinding</code> 绑定卷的默认超时时间是 600 秒。</p><p>示例中，我将自定义一个调度器，将 <code>NodeResourcesFit</code> 的评分策略配置为 <code>MostAllocated</code>，<code>VolumeBinding</code> 的超时时间配置为 60 秒。</p><h4 id=配置-kubeschedulerconfiguration>配置 <code>KubeSchedulerConfiguration</code></h4><p>首先，通过 <code>KubeSchedulerConfiguration</code> 对象自定义了一个调度器，叫做 my-custom-scheduler：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubescheduler.config.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeSchedulerConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>profiles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-scheduler</span><span class=w> </span><span class=c># 调度器名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>score</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NodeResourcesFit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pluginConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NodeResourcesFit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scoringStrategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>MostAllocated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>VolumeBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bindTimeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>由于 <code>KubeSchedulerConfiguration</code> 对象本质上是 kube-scheduler 的配置文件，为了后续部署的时候方便使用，可以通过定义一个 <code>ConfigMap</code> 包含 <code>KubeSchedulerConfiguration</code> 的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-scheduler-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>my-scheduler-config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    apiVersion: kubescheduler.config.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=sd>    kind: KubeSchedulerConfiguration
</span></span></span><span class=line><span class=cl><span class=sd>    profiles:
</span></span></span><span class=line><span class=cl><span class=sd>    - schedulerName: my-custom-scheduler # 调度器名称
</span></span></span><span class=line><span class=cl><span class=sd>      plugins:
</span></span></span><span class=line><span class=cl><span class=sd>        score:
</span></span></span><span class=line><span class=cl><span class=sd>          enabled:
</span></span></span><span class=line><span class=cl><span class=sd>          - name: NodeResourcesFit
</span></span></span><span class=line><span class=cl><span class=sd>            weight: 1
</span></span></span><span class=line><span class=cl><span class=sd>      pluginConfig:
</span></span></span><span class=line><span class=cl><span class=sd>      - name: NodeResourcesFit
</span></span></span><span class=line><span class=cl><span class=sd>        args:
</span></span></span><span class=line><span class=cl><span class=sd>          scoringStrategy:
</span></span></span><span class=line><span class=cl><span class=sd>            type: MostAllocated
</span></span></span><span class=line><span class=cl><span class=sd>            resources:
</span></span></span><span class=line><span class=cl><span class=sd>            - name: cpu
</span></span></span><span class=line><span class=cl><span class=sd>              weight: 1
</span></span></span><span class=line><span class=cl><span class=sd>            - name: memory
</span></span></span><span class=line><span class=cl><span class=sd>              weight: 1
</span></span></span><span class=line><span class=cl><span class=sd>      - name: VolumeBinding
</span></span></span><span class=line><span class=cl><span class=sd>        args:
</span></span></span><span class=line><span class=cl><span class=sd>          bindTimeoutSeconds: 60</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=部署-deployment-应用-kube-scheduler>部署 Deployment 应用 kube-scheduler</h4><p>然后，我们需要部署 kube-scheduler 应用我们自定义的调度器，为此可以定义一个 Deployment：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># serviceAccountName 注意需要配置权限</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>leader-elect=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>config=/etc/kubernetes/my-scheduler-config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- -<span class=l>v=5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>registry.k8s.io/kube-scheduler:v1.30.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-scheduler-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/my-scheduler-config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>my-scheduler-config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-scheduler-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-scheduler-config</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>注意：这里我们直接使用了 kube-scheduler 官方镜像，只是传递了不同的配置文件而已。</p><p>到这里你一定会问：自己部署的自定义调度器与已经存在的默认调度器会有冲突吗？只要 <code>schedulerName</code> 不同就不会有冲突，两个调度器各跑各的。通过自己部署的方式也避免了对默认调度器的任何干预。</p><p>至此，简单的两步就实现了自定义调度器。</p><h4 id=验证>验证</h4><p>我们通过部署两个 pod ，分别使用默认调度器 default-scheduler 和我们的自定义调度器 my-custom-scheduler ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># schedulerName 默认就是使用 default-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-custom</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>my-custom-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>然后观察自定义调度器的日志：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-log.jpg data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-log.jpg, https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-log.jpg 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-log.jpg 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-log.jpg title=https://raw.githubusercontent.com/RifeWang/images/master/k8s/scheduler-log.jpg></p><p>从图中可以看到，自定义调度器工作正常，顺利完成了 pod 的调度，且与默认调度器互不影响。</p><hr><p>参考资料：</p><ul><li><em><a href=https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/ target=_blank rel="noopener noreffer">https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/</a></em></li><li><em><a href=https://kubernetes.io/docs/reference/scheduling/config/ target=_blank rel="noopener noreffer">https://kubernetes.io/docs/reference/scheduling/config/</a></em></li><li><em><a href=https://kubernetes.io/docs/reference/config-api/kube-scheduler-config.v1/ target=_blank rel="noopener noreffer">https://kubernetes.io/docs/reference/config-api/kube-scheduler-config.v1/</a></em></li><li><em><a href=https://arthurchiao.art/blog/k8s-scheduling-plugins-zh/ target=_blank rel="noopener noreffer">https://arthurchiao.art/blog/k8s-scheduling-plugins-zh/</a></em></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-06-15</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://rifewang.github.io/k8s-custom-scheduler/ data-title="Kubernetes scheduler 概述及自定义调度器" data-hashtags=Kubernetes><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://rifewang.github.io/k8s-custom-scheduler/ data-hashtag=Kubernetes><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://rifewang.github.io/k8s-custom-scheduler/ data-title="Kubernetes scheduler 概述及自定义调度器"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://rifewang.github.io/k8s-custom-scheduler/ data-title="Kubernetes scheduler 概述及自定义调度器"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://rifewang.github.io/k8s-custom-scheduler/ data-title="Kubernetes scheduler 概述及自定义调度器"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kubernetes/>Kubernetes</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/k8s-service-long-lived-connection/ class=prev rel=prev title="Kubernetes Service 与 long-lived connections"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Kubernetes Service 与 long-lived connections</a>
<a href=/image-search-use-client-model/ class=next rel=next title=以图搜图架构优化：使用客户端模型提取图像特征>以图搜图架构优化：使用客户端模型提取图像特征<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>凌虚</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>