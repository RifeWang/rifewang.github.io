<!doctype html><html lang=en><head><title>时序数据库 InfluxDB（三） · 凌虚 Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="凌虚"><meta name=description content="时序数据库 InfluxDB（三）"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="时序数据库 InfluxDB（三）"><meta name=twitter:description content="时序数据库 InfluxDB（三）"><meta property="og:title" content="时序数据库 InfluxDB（三）"><meta property="og:description" content="时序数据库 InfluxDB（三）"><meta property="og:type" content="article"><meta property="og:url" content="https://rifewang.github.io/posts/influxdb/3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-27T13:25:48+08:00"><meta property="article:modified_time" content="2019-10-27T13:25:48+08:00"><link rel=canonical href=https://rifewang.github.io/posts/influxdb/3/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.110.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>凌虚 Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=/translation/>译文</a></li><li class=navigation-item><a class=navigation-link href=/about/>关于</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://rifewang.github.io/posts/influxdb/3/>时序数据库 InfluxDB（三）</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-10-27T13:25:48+08:00>October 27, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/influxdb/>InfluxDB</a></div></div></header><div class=post-content><hr><h3 id=数据类型>数据类型
<a class=heading-link href=#%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><hr><p>InfluxDB 是一个无结构模式，这也就是说你无需事先定义好表以及表的数据结构。</p><p>InfluxDB 支持的数据类型非常简单：</p><ul><li>measurement : string</li><li>tag key : string</li><li>tag value : string</li><li>field key : string</li><li>field value : string , float , interger , boolean</li></ul><p>你可以看到除了 field value 支持的数据类型多一点之外，其余全是字符串类型。</p><p>当然还有最重要的 timestamp ，InfluxDB 中的时间都是 UTC 时间，而且时间精度非常高，默认为纳秒。</p><hr><h3 id=数据结构设计>数据结构设计
<a class=heading-link href=#%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84%e8%ae%be%e8%ae%a1><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><hr><p>在实际使用中，数据都是存储在 tag 或者 field 中，这两者最重要的区别就是，tag 会构建索引（也就是说查询时，where 条件里的是 tag ，则查询性能更高），field 则不会被索引。</p><p>存储数据到底是使用 tag 还是 field ，参考以下原则：</p><ul><li>常用于查询条件的数据存储为 tag 。</li><li>计划使用 GROUP BY() 的数据存储为 tag 。</li><li>计划使用 InfluxQL function 的数据存储为 field 。</li><li>数据不只是 string 类型的存储为 field 。</li></ul><p>对于标识性的名称，如 database、RP、user、measurement、tag key、field key 这些应该避免使用 InfluxQL 中的关键字。</p><p>其它需要注意的原则：</p><ul><li><p>不要有过于庞大的 series 。若在 tag 中使用 UUID、hash、随机字符串等将会导致数量庞大的 series ，这将会导致更高的内存使用率，尤其是系统内存有限的情况下需要额外注意。</p></li><li><p>measurement 名称不应该包含具体的数据（表名就是一个单纯的表名），你应该使用不同的 tag 去区分数据，而不是 measurement 名称。</p></li><li><p>一个 tag 中不要放置多条信息，复杂的信息合理拆分为多个 tag 有助于简化查询并减少使用正则。</p></li></ul><hr><h3 id=索引>索引
<a class=heading-link href=#%e7%b4%a2%e5%bc%95><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><hr><p>InfluxDB 通过构建索引可以提高查询性能。InfluxDB 中的索引有两种：In-memory 和 TSI 。这两种索引只能选择一种，且无法动态更改，一旦更改必须重启 InfluxDB 。</p><p>In-memory ：索引被存储在内存中，这也是默认使用的方式，性能更高。</p><p>TSI（ Time Series Index ）：In-memory 索引可以支持千万级别的 series ，然而内存资源终归是有限的，为了支持亿级和十亿级别的 series 数据，TSI 应运而生，其会将索引映射到磁盘文件上。</p><p>索引相关配置项（默认的配置文件为 influxdb.conf ）：</p><ul><li>索引方式，inmem 或者 tsi1 ：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>index-version = &#34;inmem&#34;
</span></span></code></pre></div><ul><li>in-memory 相关设置：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>max-series-per-database = 1000000
</span></span><span style=display:flex><span>max-values-per-tag = 100000
</span></span></code></pre></div><p>max-series-per-database ：每个数据库允许的最大 series 数量，默认一百万，一旦达到上限，再写入新的 series 则会得到一个 500 错误，向已经存在的 series 写入数据不受影响。设置为 0 则意味着没有限制。</p><p>max-values-per-tag ：每个 tag key 允许的最大 tag values 数量，默认十万，类似的，一旦达到上限，无法写入新的 tag value ，而向已经存在的 tag value 写入数据不受影响。设置为 0 则意味着没有限制。</p><ul><li>TSI（ tsi1 ）相关设置：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>max-index-log-file-size = &#34;1m&#34;
</span></span><span style=display:flex><span>series-id-set-cache-size = 100
</span></span></code></pre></div><p>max-index-log-file-size ：预写日志的文件大小达到多大的阈值之后，将其压缩为索引文件，阈值越低，压缩越快，堆内存使用率越低，但会降低写入的吞吐量。</p><p>series-id-set-cache-size ：使用内存缓存的 series 集的大小，由于 TSI 索引存储在了磁盘文件中，因此使用时需要额外的计算工作，但如果将索引结果缓存起来的话就可以避免重复的计算，提高查询性能。默认缓存 100 个 series ，这个值越大则使用的堆内存越大，设置为 0 则不缓存。</p><hr><p>相关文章：</p><ul><li><a href=/posts/influxdb/1/>时序数据库 InfluxDB（一）</a></li><li><a href=/posts/influxdb/2/>时序数据库 InfluxDB（二）</a></li><li><a href=/posts/influxdb/3/>时序数据库 InfluxDB（三）</a></li><li><a href=/posts/influxdb/4/>时序数据库 InfluxDB（四）</a></li><li><a href=/posts/influxdb/5/>时序数据库 InfluxDB（五）</a></li><li><a href=/posts/influxdb/6/>时序数据库 InfluxDB（六）</a></li><li><a href=/posts/influxdb/7/>时序数据库 InfluxDB（七）</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
凌虚
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>