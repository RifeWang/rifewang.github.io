<!doctype html><html lang=en><head><title>时序数据库 InfluxDB（五） · 凌虚 Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="凌虚"><meta name=description content="时序数据库 InfluxDB（五）"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="时序数据库 InfluxDB（五）"><meta name=twitter:description content="时序数据库 InfluxDB（五）"><meta property="og:title" content="时序数据库 InfluxDB（五）"><meta property="og:description" content="时序数据库 InfluxDB（五）"><meta property="og:type" content="article"><meta property="og:url" content="https://rifewang.github.io/posts/influxdb/5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-30T13:33:30+08:00"><meta property="article:modified_time" content="2019-10-30T13:33:30+08:00"><link rel=canonical href=https://rifewang.github.io/posts/influxdb/5/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.110.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>凌虚 Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://rifewang.github.io/posts/influxdb/5/>时序数据库 InfluxDB（五）</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-10-30T13:33:30+08:00>October 30, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
One-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/influxdb/>InfluxDB</a></div></div></header><div class=post-content><hr><h1 id=系统监控>系统监控
<a class=heading-link href=#%e7%b3%bb%e7%bb%9f%e7%9b%91%e6%8e%a7><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><hr><p>InfluxDB 自带有一个监控系统，默认情况下此功能是开启的，每隔 10 秒中采集一次系统数据并把数据写入到 _internal 数据库中，其默认使用名称为 monitor 的 RP（数据保留 7 天），相关配置见配置文件中的：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[monitor]
</span></span><span style=display:flex><span>  store-enabled = true
</span></span><span style=display:flex><span>  store-database = &#34;_internal&#34;
</span></span><span style=display:flex><span>  store-interval = &#34;10s&#34;
</span></span></code></pre></div><p>_internal 数据库与其它数据库的使用方式完全一致，其记录的统计数据分为多个 measurements ：</p><ul><li>cq ：连续查询</li><li>database ：数据库</li><li>httpd ：HTTP 相关</li><li>queryExecutor ：查询执行器</li><li>runtime ：运行时</li><li>shard ：分片</li><li>subscriber ：订阅者</li><li>tsm1_cache ：TSM cache 缓存</li><li>tsm1_engine ：TSM 引擎</li><li>tsm1_filestore ：TSM filestore</li><li>tsm1_wal ：TSM 预写日志</li><li>write ：数据写入</li></ul><p>比如查询最近一次统计的数据写入情况：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>select * from &#34;write&#34; order by time desc limit 1
</span></span></code></pre></div><p>_internal 数据库里的这些 measurements 中具体有哪些 field ，每个 field 数据又代表了什么含义，请参考官方文档：</p><p><a href=https://docs.influxdata.com/platform/monitoring/influxdata-platform/tools/measurements-internal/#influxdb-internal-measurements-and-fields>https://docs.influxdata.com/platform/monitoring/influxdata-platform/tools/measurements-internal/#influxdb-internal-measurements-and-fields</a></p><p><strong>InfluxDB 相关命令</strong>：</p><ul><li>show stats</li><li>show diagnostics</li></ul><p>1、</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>SHOW STATS [ FOR &#39;&lt;component&gt;&#39; | &#39;indexes&#39; ]
</span></span></code></pre></div><p>show stats 命令返回的系统数据与 _internal 数据库中的数据结构是一致的，这里的 component 其实就是对应 _internal 中的 measurement ，比如：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>show stats for &#39;queryExecutor&#39;
</span></span></code></pre></div><p>唯一例外的是：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>show stats for &#39;indexes&#39;
</span></span></code></pre></div><p>其会返回所有索引使用的内存大小预估值，且没有 _internal 中的 measurement 与之对应。</p><p>2、</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>SHOW DIAGNOSTIC
</span></span></code></pre></div><p>返回系统的诊断信息，包括：版本信息、正常运行时间、主机名、服务器配置、内存使用情况、Go 运行时等，这些数据不会存储到 _internal 数据库中。</p><p><strong>InfluxDB 也支持通过 HTTP 接口获取系统信息</strong>：</p><ul><li>/metrics ：这个接口返回的数据是诸如垃圾回收、内存分配等的 Go 相关指标。</li><li>/debug/vars ：这个接口返回的数据与 _internal 数据类似。</li></ul><hr><h1 id=备份和恢复>备份和恢复
<a class=heading-link href=#%e5%a4%87%e4%bb%bd%e5%92%8c%e6%81%a2%e5%a4%8d><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h1><hr><p>InfluxDB 支持本地或远程的数据备份和恢复，其是通过 TCP 连接进行的，对于远程方式，你必须修改配置文件中的：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>bind-address = &#34;127.0.0.1:8088&#34;
</span></span></code></pre></div><p>将其设置为本机在网络上可通信的对外地址，然后重启服务，执行命令时需要通过 -host 参数对应这个地址。</p><p>备份命令：</p><p><img src=/images/influxdb/backup.png alt=backup></p><p>恢复命令：</p><p><img src=/images/influxdb/restore.png alt=restore></p><p>备份和恢复的命令参数非常相似，参数的含义也是一目了然的，比如你可以备份指定的数据库、RP、shard，恢复到新的数据库、RP 。</p><p>由于备份的格式进行过不兼容的更新，-portable 就是指定使用新的备份格式（强烈建议使用），-online 就是老的备份格式。</p><p>所有备份都是全量备份，不支持增量备份。你可能会问，不是有 -start 和 -end 可以指定备份数据的时间范围吗？没错，是可以的，但是备份是在数据块上执行，并不是逐点执行，而数据块又是高度压缩的，你使用 -start 和 -end 时，其还会备份到同一个数据块中的其它数据点，也就是说：</p><ul><li>备份和还原可能会包含指定时间范围之外的数据。</li><li>如果包含重复的数据点，再次写入则会覆盖现有数据点。</li></ul><p>另外，恢复数据时，无法直接恢复到一个已经存在的数据库或者 RP 中，为此你只能先使用一个临时的数据库和 RP ，然后再重新将数据插入到已有的数据库中（比如使用 select &mldr; into 语句）。</p><hr><p>相关文章：</p><ul><li><a href=/posts/influxdb/1/>时序数据库 InfluxDB（一）</a></li><li><a href=/posts/influxdb/2/>时序数据库 InfluxDB（二）</a></li><li><a href=/posts/influxdb/3/>时序数据库 InfluxDB（三）</a></li><li><a href=/posts/influxdb/4/>时序数据库 InfluxDB（四）</a></li><li><a href=/posts/influxdb/5/>时序数据库 InfluxDB（五）</a></li><li><a href=/posts/influxdb/6/>时序数据库 InfluxDB（六）</a></li><li><a href=/posts/influxdb/7/>时序数据库 InfluxDB（七）</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
凌虚
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>