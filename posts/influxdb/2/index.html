<!doctype html><html lang=en><head><title>时序数据库 InfluxDB（二） · 凌虚 Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="凌虚"><meta name=description content="时序数据库 InfluxDB（二）"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="时序数据库 InfluxDB（二）"><meta name=twitter:description content="时序数据库 InfluxDB（二）"><meta property="og:title" content="时序数据库 InfluxDB（二）"><meta property="og:description" content="时序数据库 InfluxDB（二）"><meta property="og:type" content="article"><meta property="og:url" content="https://rifewang.github.io/posts/influxdb/2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-26T13:14:35+08:00"><meta property="article:modified_time" content="2019-10-26T13:14:35+08:00"><link rel=canonical href=https://rifewang.github.io/posts/influxdb/2/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.110.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>凌虚 Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://rifewang.github.io/posts/influxdb/2/>时序数据库 InfluxDB（二）</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-10-26T13:14:35+08:00>October 26, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
One-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=/categories/influxdb/>InfluxDB</a></div></div></header><div class=post-content><hr><h4 id=rp>RP
<a class=heading-link href=#rp><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><hr><p>先回顾一下 RP 策略（ retention policy ），它由三个部分构成：</p><ul><li>DURATION：数据的保留时长。</li><li>REPLICATION：集群模式下数据的副本数，单节点无效。</li><li>SHARD DURATION：可选项，shard group 划分的时间范围。</li></ul><p>前两个部分没啥好说的，而 shard duration 和 shard group 的概念你可能会感到比较陌生。</p><p>shard 是什么？</p><p>先来看数据的层次结构：</p><p><img src=/images/influxdb/shard.webp alt=image></p><p>如果所示，一个 database 对应一个实际的磁盘上的文件夹，该数据库下不同的 RP 策略对应不同的文件夹。</p><p>shard group 只是一个逻辑概念，并没有实际的磁盘文件夹，shard group 包含有一个或多个 shard 。</p><p>最终的数据是存储在 shard 中的，每个 shard 也对应一个具体的磁盘文件目录，数据是按照时间范围分割存储的，shard duration 也就是划分 shard group 的时间范围（例如 shard duration 如果是一周，那么第一周的数据就会存储到一个 shard group 中，第二周的数据会存储到另外一个 shard group 中，以此类推）。</p><p>另外，每个 shard 目录下都有一个 TSM 文件（后缀名为 .tsm ），正是这个文件存储了最后编码和压缩后的数据。shard group 下的 shard 是按照 series 来划分的，每个 shard 包含一组特定的 series ，换句话说特定 shard group 中的特定 series 上的所有 points 点都存储在同一个 TSM 文件中。</p><hr><h4 id=shard-duration>shard duration
<a class=heading-link href=#shard-duration><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><hr><p>shard 从属于唯一一个 shard group ，shard duration 和 shard group duration 是同一个概念。</p><p>如前文所述，数据按照时间范围分割存储，分割的时间范围由 RP 策略中的 shard group duration 指定。</p><p>默认情况下，shard group duration 根据 RP duration 的值来确定，对应关系如下图：</p><p><img src=/images/influxdb/rp-duration.png alt=image></p><p>RP 策略是不可或缺的，如果未设置则会使用默认的名称为 autogen 的 RP ，它的 duration 是 infinite 也就是数据不会过期，shard group duration 是 7 天（ duration 是 infinite 对应的就是 > 6 months 这一栏）。</p><p>shard group duration 设置为多久才最好？</p><ul><li>长时间范围：有利于存储更多数据，整体性能更好。</li><li>短时间范围：灵活性更高，有利于删除过期数据和记录增量备份。删除过期数据是删除整个 shard group 而不是单个的 shard 。</li></ul><p>默认配置对于大多数场景都运行的很好，然而，高吞吐量或长时间运行的实例将受益于更长的 shard group duration ，官方建议的配置如下：</p><p><img src=/images/influxdb/rp-duration-config.webp alt=image></p><p>其它一些需要考虑的因素：</p><ul><li>shard group 应该包含最频繁查询的最长时间范围的两倍。</li><li>每个 shard group 应该包含超过十万个 point 。</li><li>shard group 中的每个 series 应该包含超过一千个 point 。</li></ul><p>另外，批量插入长时间范围内的大量历史数据将会一次触发大量 shard 的创建，并发访问和写入成百上千的 shard 会导致性能降低和内存耗尽，对于这种情况建议临时设置较长的 shard group duration 比如 52 周。</p><p>RP 策略可以动态调整，删除一个 RP 将会删除其下的所有数据。</p><hr><p>相关文章：</p><ul><li><a href=/posts/influxdb/1/>时序数据库 InfluxDB（一）</a></li><li><a href=/posts/influxdb/2/>时序数据库 InfluxDB（二）</a></li><li><a href=/posts/influxdb/3/>时序数据库 InfluxDB（三）</a></li><li><a href=/posts/influxdb/4/>时序数据库 InfluxDB（四）</a></li><li><a href=/posts/influxdb/5/>时序数据库 InfluxDB（五）</a></li><li><a href=/posts/influxdb/6/>时序数据库 InfluxDB（六）</a></li><li><a href=/posts/influxdb/7/>时序数据库 InfluxDB（七）</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
凌虚
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>