<!doctype html><html lang=en><head><title>使用 Puppeteer 构建自动化端到端测试 · 凌虚 Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="凌虚"><meta name=description content="使用 Puppeteer 构建自动化端到端测试"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Puppeteer 构建自动化端到端测试"><meta name=twitter:description content="使用 Puppeteer 构建自动化端到端测试"><meta property="og:title" content="使用 Puppeteer 构建自动化端到端测试"><meta property="og:description" content="使用 Puppeteer 构建自动化端到端测试"><meta property="og:type" content="article"><meta property="og:url" content="https://rifewang.github.io/posts/uncate/puppeteer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-22T15:04:16+08:00"><meta property="article:modified_time" content="2019-03-22T15:04:16+08:00"><link rel=canonical href=https://rifewang.github.io/posts/uncate/puppeteer/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.110.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>凌虚 Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=/translation/>译文</a></li><li class=navigation-item><a class=navigation-link href=/about/>关于</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://rifewang.github.io/posts/uncate/puppeteer/>使用 Puppeteer 构建自动化端到端测试</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-03-22T15:04:16+08:00>March 22, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/node.js/>Node.js</a></span></div></div></header><div class=post-content><p>端到端测试指的是将系统作为一个黑盒，模拟正常用户行为，跨越从前端到后端整个软件系统，是一种全局性的整体测试。</p><p>来看本文的示例：</p><video autoplay width=100% class=video-shortcode preload controls>
<source src=/videos/puppeteer-eg.mp4 type>There should have been a video here but your browser does not seem
to support it.</video><p>你在视频中看到的所有操作全部都是由程序自动完成的，就像真实的用户一样，通过这种自动化的方式可以很好的提升我们的测试效率从而保证交付的质量。</p><p>完成这样的操作相当简单，只需要 Puppeteer 就够了。Puppeteer 是一个 node 库，通过它提供的高级 API 便可以控制 chromium 或者 chrome ，换句话说，在浏览器中进行的绝大部分人工操作都可以通过在 node 程序中调用 Puppeteer 的 API 来完成。</p><p>本文示例中的所有操作无外乎于：</p><ul><li>获取页面元素</li><li>键盘输入</li><li>鼠标操作</li><li>文件上传</li><li>执行原生JS</li></ul><p>一、打开浏览器跳转页面：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>const browser = await puppeteer.launch({
</span></span><span style=display:flex><span>headless: false,  // 打开浏览器
</span></span><span style=display:flex><span>defaultViewport: {  // 设置视窗宽高
</span></span><span style=display:flex><span>    width: 1200,
</span></span><span style=display:flex><span>    height: 800
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>const page = await browser.newPage();
</span></span><span style=display:flex><span>await page.goto(url);  // 跳转页面
</span></span></code></pre></div><p>二、获取输入框并输入：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// -----------------------输入账号密码----------------------------
</span></span><span style=display:flex><span>const input_username = await page.waitForSelector(&#39;input[placeholder=&#34;用户名&#34;]&#39;);
</span></span><span style=display:flex><span>const input_password = await page.waitForSelector(&#39;input[placeholder=&#34;密码&#34;]&#39;);
</span></span><span style=display:flex><span>await input_username.type(username);
</span></span><span style=display:flex><span>await input_password.type(password);
</span></span><span style=display:flex><span>// ---------------------------------------------------
</span></span></code></pre></div><p>通过 page.waitForSelector 方法等待获取到指定的页面元素，也就是 elementHandle , 再直接执行 elementHandle 的 type 方法即可完成键盘输入。</p><p>三、通过滑动验证：</p><p>1、滑动验证必须要禁用 navigator ，这里通过 page.evaluate 方法直接执行原生JS 即可：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>await page.evaluate(async () =&gt; {  // 滑动验证禁用 navigator
</span></span><span style=display:flex><span>    await Object.defineProperty(navigator, &#39;webdriver&#39;, {get: () =&gt; false})
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>2、鼠标操作进行验证：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>async function aliNC (page) {
</span></span><span style=display:flex><span>  const nc = await (await page.waitForSelector(&#39;.nc-lang-cnt&#39;)).boundingBox();  // 获取滑动验证边界框
</span></span><span style=display:flex><span>  await page.mouse.move(nc.x, nc.y);  // 鼠标移动到起始位置
</span></span><span style=display:flex><span>  await page.mouse.down();  // 鼠标按下
</span></span><span style=display:flex><span>  const steps = Math.floor(Math.random() * 50 + 20);  // 随机 steps
</span></span><span style=display:flex><span>  await page.mouse.move(nc.x + nc.width, nc.y, { steps:  steps});  // 移动到滑块末端位置
</span></span><span style=display:flex><span>  await page.mouse.up();  // 鼠标松开
</span></span><span style=display:flex><span>  await page.waitForTimeout(1200);  // 延时等待验证完成
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>先获取到滑动验证的页面元素，再通过 elementHandle 的 boundingBox 方法获取边界框，从而确定 X、Y 二维坐标。</p><p>通过 page 的 mouse 相关方法即可进行 move 鼠标移动、down 鼠标按下、up 鼠标松开等操作，需要注意的是我们最好随机生成 steps 来控制鼠标移动的快慢从而避免验证失败。</p><p>四、上传文件：</p><p>现获取到上传相关的 input 元素即 elementHandle ，然后再调用 elementHandle 的 uploadFile(&mldr;filePaths) 方法即可，filePaths 就是文件的路径，如果是相对路径则是相对于当前工作目录。</p><p>五、其它：</p><p>你会发现几乎所有用户动作就是先获取到相关元素，然后进行键盘或鼠标操作，把它们组合起来就成一整套操作流程。</p><p>是自动化的吗？是的，没有人工操作，都是程序在自动进行。</p><p>是否真的有效？有效，所有操作都是模拟用户进行的真实行为，从看到前端页面，到提交数据，到请求后端接口，可以说是走了一遍完整的流程，并且整个过程也是可视的，在测试过程中即可发现异常。</p><p>最后，我相信 Puppeteer 值得你好好玩一玩，更多用法和 API 还是多翻翻官网，真的很简单。</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
凌虚
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>