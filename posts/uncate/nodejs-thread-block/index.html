<!doctype html><html lang=en><head><title>CPU 密集型任务会阻塞 Node.js 吗【译】 · 凌虚 Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="凌虚"><meta name=description content="CPU 密集型任务会阻塞 Node.js 吗【译】"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="CPU 密集型任务会阻塞 Node.js 吗【译】"><meta name=twitter:description content="CPU 密集型任务会阻塞 Node.js 吗【译】"><meta property="og:title" content="CPU 密集型任务会阻塞 Node.js 吗【译】"><meta property="og:description" content="CPU 密集型任务会阻塞 Node.js 吗【译】"><meta property="og:type" content="article"><meta property="og:url" content="https://rifewang.github.io/posts/uncate/nodejs-thread-block/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-24T17:19:31+08:00"><meta property="article:modified_time" content="2019-09-24T17:19:31+08:00"><link rel=canonical href=https://rifewang.github.io/posts/uncate/nodejs-thread-block/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.0fa2dc75ed1b76894ac0e062b10a6c4730daa745096fa120114b290ed8a48788.css integrity="sha256-D6Lcde0bdolKwOBisQpsRzDap0UJb6EgEUspDtikh4g=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.110.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>凌虚 Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=/translation/>译文</a></li><li class=navigation-item><a class=navigation-link href=/about/>关于</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://rifewang.github.io/posts/uncate/nodejs-thread-block/>CPU 密集型任务会阻塞 Node.js 吗【译】</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-09-24T17:19:31+08:00>September 24, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
One-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/node.js/>Node.js</a></span></div></div></header><div class=post-content><p><em>本文翻译自：
<a href=https://betterprogramming.pub/is-node-js-really-single-threaded-7ea59bcc8d64>https://betterprogramming.pub/is-node-js-really-single-threaded-7ea59bcc8d64</a></em></p><p>CPU密集型任务会阻塞 Node.js 吗？</p><p>让我们使用加密任务做个简单测试：</p><p><img src=/images/uncate/nodejs-block1.png alt></p><p>如图所示，连续执行四次加密任务，打印耗时，结果会发生什么？</p><p>结果输出：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Hash:  1232
</span></span><span style=display:flex><span>Hash:  1237
</span></span><span style=display:flex><span>Hash:  1268
</span></span><span style=display:flex><span>Hash:  1297
</span></span></code></pre></div><p>这四次加密任务计时的起始时间都是相同的，然后最终的结束时间却几乎一致，这个结果说明了什么？说明它们是并发执行的。</p><p><img src=/images/uncate/nodejs-block2.png alt></p><p>如果不是并发执行，那么结果就会如下图所示：</p><p><img src=/images/uncate/nodejs-block3.jpeg alt></p><p>那么为什么这里没有发生阻塞？</p><p><img src=/images/uncate/nodejs-block4.jpeg alt></p><p>Node.js 的执行过程如上图所示，我们要注意的是 libuv 默认使用了四个线程！上述示例中的四个加密任务分别推送到了四个不同的线程中去并发执行，所以才没有发生阻塞。</p><p>那么问题来了？如果连续执行五个加密任务呢？</p><p><img src=/images/uncate/nodejs-block5.png alt></p><p>输出结果：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Hash:  1432
</span></span><span style=display:flex><span>Hash:  1437
</span></span><span style=display:flex><span>Hash:  1468
</span></span><span style=display:flex><span>Hash:  1497
</span></span><span style=display:flex><span>Hash:  2104
</span></span></code></pre></div><p>可以看到前四个任务仍然是并发执行的，但是第五个任务发生了阻塞。</p><p><img src=/images/uncate/nodejs-block6.png alt></p><p>为什么？因此 libuv 的四个线程都在忙碌，第五个任务只有等待线程的任务执行完毕才能推送到线程中去执行。</p><p>过程如下图所示：</p><p>1、四个线程都在忙碌，其它任务必须等待：</p><p><img src=/images/uncate/nodejs-block7.jpeg alt></p><p>2、某个线程任务完成，继续执行其它任务：</p><p><img src=/images/uncate/nodejs-block8.jpeg alt></p><p>libuv 线程池中的线程数量是否可以设置？
通过环境变量 UV_THREADPOOL_SIZE 即可设置。</p><p>比如：</p><p><img src=/images/uncate/nodejs-block9.png alt></p><p>我把线程数设置为 5 ，执行的结果就会是下图所示：</p><p><img src=/images/uncate/nodejs-block10.png alt></p><p>请注意测试环境的 CPU 核心数是四个，需要说明的有两点：第一，五个任务被推送到了五个线程中去并发执行，这一点上文已经说明；第二，每个任务的耗时有了明显的增加，为什么？因为我们只有四核，但是却有五个线程，操作系统需要进行平衡调度、通过上下文切换以保证每个线程分配到相同的时间去执行任务。</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
凌虚
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>