<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>以图搜图系统工程实践 - 凌虚 Blog</title><meta name=Description content="以图搜图系统工程实践"><meta property="og:title" content="以图搜图系统工程实践"><meta property="og:description" content="以图搜图系统工程实践"><meta property="og:type" content="article"><meta property="og:url" content="https://rifewang.github.io/image-search-system2/"><meta property="og:image" content="https://rifewang.github.io/images/avatar.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-11T00:00:00+08:00"><meta property="article:modified_time" content="2023-02-27T15:51:36+08:00"><meta property="og:site_name" content="凌虚 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:title content="以图搜图系统工程实践"><meta name=twitter:description content="以图搜图系统工程实践"><meta name=application-name content="凌虚的博客"><meta name=apple-mobile-web-app-title content="凌虚的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://rifewang.github.io/image-search-system2/><link rel=prev href=https://rifewang.github.io/image-search-system/><link rel=next href=https://rifewang.github.io/image-search-total/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"以图搜图系统工程实践","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rifewang.github.io\/image-search-system2\/"},"image":["https:\/\/rifewang.github.io\/images\/avatar.png"],"genre":"posts","keywords":"Engineering","wordcount":2688,"url":"https:\/\/rifewang.github.io\/image-search-system2\/","datePublished":"2020-04-11T00:00:00+08:00","dateModified":"2023-02-27T15:51:36+08:00","license":"Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)","publisher":{"@type":"Organization","name":"凌虚","logo":"https:\/\/rifewang.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"凌虚"},"description":"以图搜图系统工程实践"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">以图搜图系统工程实践</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>凌虚</a></span>&nbsp;<span class=post-category>included in <a href=/categories/engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Engineering</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-04-11>2020-04-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2688 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#cnn>CNN</a><ul><li><a href=#1归一化>1、归一化</a></li><li><a href=#2image-说明>2、Image 说明</a></li><li><a href=#3bytes-转换>3、Bytes 转换</a></li><li><a href=#4黑边处理>4、黑边处理</a></li></ul></li><li><a href=#向量搜索引擎-milvus>向量搜索引擎 Milvus</a><ul><li><a href=#1对-cpu-有要求>1、对 CPU 有要求</a></li><li><a href=#2容量规划>2、容量规划</a></li><li><a href=#3系统配置>3、系统配置</a></li><li><a href=#4数据库设计>4、数据库设计</a><ul><li><a href=#collection--partition>collection & partition</a></li><li><a href=#条件过滤>条件过滤</a></li><li><a href=#结构化数据与向量的映射>结构化数据与向量的映射</a></li><li><a href=#索引类型选择>索引类型选择</a></li></ul></li><li><a href=#5搜索结果处理>5、搜索结果处理</a><ul><li><a href=#过滤-id-为--1-的数据>过滤 ID 为 -1 的数据</a></li><li><a href=#翻页>翻页</a></li><li><a href=#业务上的相似性阈值>业务上的相似性阈值</a></li></ul></li></ul></li><li><a href=#结语>结语</a></li></ul></nav></div></div><div class=content id=content><h1 id=以图搜图系统工程实践>以图搜图系统工程实践</h1><p>之前写过一篇概述: <a href=/posts/engineering/image-search-system/ rel>以图搜图系统概述</a> 。</p><p>以图搜图系统需要解决的主要问题是：</p><ul><li>提取图像特征向量（用特征向量去表示一幅图像）</li><li>特征向量的相似度计算（寻找内容相似的图像）</li></ul><p>对应的工程实践，具体为：</p><ul><li>卷积神经网络 <code>CNN</code> 提取图像特征</li><li>向量搜索引擎 <code>Milvus</code></li></ul><h2 id=cnn>CNN</h2><p>使用卷积神经网路 CNN 去提取图像特征是一种主流的方案，具体的模型则可以使用 <code>VGG16</code> ，技术实现上则使用 <code>Keras</code> + <code>TensorFlow</code> ，参考 <a href=https://keras.io/applications/#extract-features-with-vgg16 target=_blank rel="noopener noreffer">Keras 官方示例</a>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>from keras.applications.vgg16 import VGG16
</span></span><span class=line><span class=cl>from keras.preprocessing import image
</span></span><span class=line><span class=cl>from keras.applications.vgg16 import preprocess_input
</span></span><span class=line><span class=cl>import numpy as np
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>model = VGG16(weights=&#39;imagenet&#39;, include_top=False)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>img_path = &#39;elephant.jpg&#39;
</span></span><span class=line><span class=cl>img = image.load_img(img_path, target_size=(224, 224))
</span></span><span class=line><span class=cl>x = image.img_to_array(img)
</span></span><span class=line><span class=cl>x = np.expand_dims(x, axis=0)
</span></span><span class=line><span class=cl>x = preprocess_input(x)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>features = model.predict(x)
</span></span></code></pre></td></tr></table></div></div><p>这里提取出来的 <code>feature</code> 就是特性向量。</p><h3 id=1归一化>1、归一化</h3><p>为了方便后续操作，我们常常会将 <code>feature</code> 进行归一化的处理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>from numpy import linalg as LA
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>norm_feat = feat[0]/LA.norm(feat[0])
</span></span></code></pre></td></tr></table></div></div><p>后续实际使用的也是归一化后的 <code>norm_feat</code> 。</p><h3 id=2image-说明>2、Image 说明</h3><p>这里加载图像使用的是 <code>keras.preprocessing</code> 的 <code>image.load_img</code> 方法即：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>from keras.preprocessing import image
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>img_path = &#39;elephant.jpg&#39;
</span></span><span class=line><span class=cl>img = image.load_img(img_path, target_size=(224, 224))
</span></span></code></pre></td></tr></table></div></div><p>实际上是 <code>Keras</code> 调用的 <code>TensorFlow</code> 的方法，详情见 <a href=https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/load_img target=_blank rel="noopener noreffer">TensorFlow 官方文档</a> ，而最后得到的 <code>image</code> 对象其实是一个 <a href=https://pillow.readthedocs.io/en/stable/reference/Image.html target=_blank rel="noopener noreffer">PIL Image</a> 实例（ <code>TensorFlow</code> 使用的 <code>PIL</code> ）。</p><h3 id=3bytes-转换>3、Bytes 转换</h3><p>实际工程中图像内容常常是通过网络进行传输的，因此相比于从 path 路径加载图片，我们更希望直接将 bytes 数据转换为 image 对象即 <a href=https://pillow.readthedocs.io/en/stable/reference/Image.html target=_blank rel="noopener noreffer">PIL Image</a> ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>import io
</span></span><span class=line><span class=cl>from PIL import Image
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># img_bytes: 图片内容 bytes
</span></span><span class=line><span class=cl>img = Image.open(io.BytesIO(img_bytes))
</span></span><span class=line><span class=cl>img = img.convert(&#39;RGB&#39;)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>img = img.resize((224, 224), Image.NEAREST)
</span></span></code></pre></td></tr></table></div></div><p>以上 <code>img</code> 与前文中的 <code>image.load_img</code> 得到的结果相同，这里需要注意的是：</p><ul><li>必须进行 <code>RGB</code> 转换</li><li>必须进行 <code>resize</code> （ <code>load_img</code> 方法的第二个参数也就是 resize ）</li></ul><h3 id=4黑边处理>4、黑边处理</h3><p>有时候图像会有比较多的黑边部分（例如截屏），而这些黑边的部分即没有实际价值，又会产生比较大的干扰，因此去除黑边也是一项常见的操作。</p><p>所谓黑边，本质上就是一行或一列的像素点全部都是 <code>(0, 0, 0)</code> ( RGB 图像)，去除黑边就是找到这些行或列，然后删除，实际是一个 numpy 的 3-D Matrix 操作。</p><p>移除横向黑边示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># -*- coding: utf-8 -*-
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import numpy as np
</span></span><span class=line><span class=cl>from keras.preprocessing import image
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def RemoveBlackEdge(img):
</span></span><span class=line><span class=cl>    &#34;&#34;&#34;移除图片横向黑边
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Args:
</span></span><span class=line><span class=cl>        img: PIL image 实例
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Returns:
</span></span><span class=line><span class=cl>        PIL image 实例
</span></span><span class=line><span class=cl>    &#34;&#34;&#34;
</span></span><span class=line><span class=cl>    width = img.width
</span></span><span class=line><span class=cl>    img = image.img_to_array(img)
</span></span><span class=line><span class=cl>    img_without_black = img[~np.all(img == np.zeros((1, width, 3), np.uint8), axis=(1, 2))]
</span></span><span class=line><span class=cl>    img = image.array_to_img(img_without_black)
</span></span><span class=line><span class=cl>    return img
</span></span></code></pre></td></tr></table></div></div><p>CNN 提取图像特征以及图像的其它相关处理先写这么多，我们再看向量搜索引擎。</p><hr><h2 id=向量搜索引擎-milvus>向量搜索引擎 Milvus</h2><p>只有图像的特征向量是远远不够的，我们还需要对这些特征向量进行动态的管理（增删改），以及计算向量的相似度并返回最邻近范围内的向量数据，而开源的向量搜索引擎 <a href=https://milvus.io/cn/ target=_blank rel="noopener noreffer">Milvus</a> 则很好的完成这些工作。</p><p>下文将会讲述具体的实践，以及要注意的地方。</p><h3 id=1对-cpu-有要求>1、对 CPU 有要求</h3><p>想要使用 <code>Milvus</code> ，首先必须要求你的 CPU 支持 <code>avx2</code> 指令集，如何查看你的 CPU 支持哪些指令集呢？对于 Linux 系统，输入指令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat /proc/cpuinfo | grep flags
</span></span></code></pre></td></tr></table></div></div><p>你将会看到形如以下的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c rdrand lahf_lm abm cpuid_fault epb invpcid_single pti intel_ppin tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid cqm xsaveopt cqm_llc cqm_occup_llc dtherm ida arat pln pts
</span></span></code></pre></td></tr></table></div></div><p><code>flags</code> 后面的这一大堆就是你的 CPU 支持的全部指令集，当然内容太多了，我只想看是否支持具体的某个指令集，比如 <code>avx2</code> ， 再加一个 grep 过滤一下即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cat /proc/cpuinfo | grep flags | grep avx2
</span></span></code></pre></td></tr></table></div></div><p>如果执行结果没有内容输出，就是不支持这个指令集，你只能换一台满足要求的机器。</p><h3 id=2容量规划>2、容量规划</h3><p>系统设计时，容量规划是需要首先考虑的地方，我们需要存储多少数据，这些数据需要多少内存以及多大的磁盘空间？</p><p>速算，上文中特征向量的每一个维度都是 <code>float32</code> 的数据类型，一个 <code>float32</code> 需要占用 <code>4 byte</code>，那么一个 512 维的向量就需要 <code>2 KB</code> ，依次类推：</p><ul><li>一千个 512 维向量需要 2 MB</li><li>一百万 512 维向量需要 2 GB</li><li>一千万 512 维向量需要 20 GB</li><li>一个亿 512 维向量需要 200 GB</li><li>十个亿 512 维向量需要 2 TB</li></ul><p>如果我们希望能将数据全部存在内存中，那么系统就至少需要对应大小的内存容量。</p><p>这里推荐你使用官方的大小计算工具: <a href=https://milvus.io/tools/sizing target=_blank rel="noopener noreffer">milvus tools</a></p><p>实际上我们的内存可能并没有那么大（内存不够没关系，milvus 会将数据自动刷写到磁盘上），另外除了这些原始的向量数据之外，还会有一些其他的数据例如日志等的存储也是我们需要考虑的地方。</p><h3 id=3系统配置>3、系统配置</h3><p>关于系统配置，官方文档有比较详细的说明：</p><ul><li><a href=https://www.milvus.io/cn/docs/v0.7.1/reference/milvus_config.md target=_blank rel="noopener noreffer">Milvus 服务端配置</a></li><li><a href=https://www.milvus.io/cn/blogs/2020-2-19-milvus-config.md target=_blank rel="noopener noreffer">如何设置系统配置项</a></li><li><a href=https://www.milvus.io/cn/docs/v0.7.1/reference/performance_tuning.md target=_blank rel="noopener noreffer">配置 Milvus 用于生产环境</a></li></ul><h3 id=4数据库设计>4、数据库设计</h3><h4 id=collection--partition>collection & partition</h4><p>在 Milvus 中，数据会按照 <code>collection</code> 和 <code>partition</code> 进行划分：</p><ul><li><code>collection</code> 就是我们理解的表。</li><li><code>partition</code> 则是 <code>collection</code> 的分区，也就是某个表内部的分区。</li></ul><p><code>partition</code> 分区在底层实现上其实与 <code>collection</code> 集合是一致的，只是前者从属于后者，但是有了分区之后，数据的组织方式变得更加灵活，我们也可以指定集合中某个特定分区进行查询，从而达到一个更高的查询性能，更多内容参考 <a href=https://www.milvus.io/cn/blogs/2019-12-16-table-partition.md target=_blank rel="noopener noreffer">分区表详细说明</a> 。</p><p>我们可以使用多少个 <code>collection</code> 和 <code>partition</code> ？
由于 <code>collection</code> 和 <code>partition</code> 的基本信息都属于元数据，而 milvus 内部进行元数据管理需要使用 <code>SQLite</code>（ milvus 内部集成）或者 <code>MySQL</code> (需要外部连接) 其中之一，如果你使用默认的 <code>SQLite</code> 去管理元数据的话，当集合和分区的数量过多时，性能损耗会很严重，因此集合和分区总数不要超过 <code>50000</code> ( 0.8.0 版本将会限制为 <code>4096</code> ) ，需要设置更多的数量则建议使用外接 <code>MySQL</code> 的方式。</p><p>Milvus 的 <code>collection</code> 和 <code>partition</code> 内部支持的数据结构非常简单，只支持 <code>ID + vector</code> ，换句话说，表只有两列，一列是 ID ，一列是向量数据。</p><p>注意：</p><ul><li>ID 目前只支持整数类型</li><li>我们需要保证 ID 在 <code>collection</code> 的层面是唯一的，而不是 <code>partition</code> 。</li></ul><h4 id=条件过滤>条件过滤</h4><p>我们使用一些传统的数据库时，往往可以指定字段进行条件过滤，但是 Milvus 并不能直接支持这项功能，然而我们是可以通过集合和分区的设计去实现简单的条件过滤，例如，我们有很多图片数据，但是这些图片数据都明确的属于具体的用户，那么我们就可以按照用户去划分 <code>partition</code> ，这样查询的时候以用户作为过滤条件其实就是指定 <code>partition</code> 即可。</p><h4 id=结构化数据与向量的映射>结构化数据与向量的映射</h4><p>由于 milvus 只支持 <code>ID + vector</code> 的数据结构，而实际业务上我们最终需要的往往是具有业务意义的结构化数据，也就是说，我们需要通过 <code>vector</code> 向量最终找到结构化数据，因此我们需要通过 <code>ID</code> 去维护结构化数据与向量之间的映射关系:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>结构化数据 ID  &lt;--&gt;  映射表  &lt;--&gt;  Milvus ID
</span></span></code></pre></td></tr></table></div></div><h4 id=索引类型选择>索引类型选择</h4><p>请参考以下文档:</p><ul><li><a href=https://www.milvus.io/cn/docs/v0.7.1/guides/index.md target=_blank rel="noopener noreffer">索引类型</a></li><li><a href=https://www.milvus.io/cn/blogs/2019-12-03-select-index.md target=_blank rel="noopener noreffer">如何选择索引类型</a></li></ul><h3 id=5搜索结果处理>5、搜索结果处理</h3><p>Milvus 的搜索结果是 <code>ID + distance</code> 的集合:</p><ul><li><code>ID</code> : <code>collection</code> 中的 <code>ID</code> 。</li><li><code>distance</code> : 0 ~ 1 的距离值，表示相似性程度，越小越相似。</li></ul><h4 id=过滤-id-为--1-的数据>过滤 ID 为 -1 的数据</h4><p>当数据集过少的时候，搜索结果可能会包含 ID 为 -1 的数据，我们需要自己去过滤掉。</p><h4 id=翻页>翻页</h4><p>向量的搜索比较特别，查询的结果是按照相似性顺序，从最相似开始往后选取 <code>topK</code> 个数据（ <code>topK</code> 需要搜索时由用户指定）。</p><p>Milvus 的搜索不支持翻页，如果我们希望在业务上实现这个功能，那么只能由我们自己去处理，比如，我想要每页 10 条数据，只显示第 3 页的数据，那么我们需要去取 <code>topK = 30</code> 的数据，然后只返回最后 10 条。</p><h4 id=业务上的相似性阈值>业务上的相似性阈值</h4><p>两张图片的特征向量的距离 <code>distance</code> 范围是 0 ~ 1 ，有些时候我们需要在业务上去判定两张图片是否相似，这时就需要我们自己去设置一个距离的阈值，当 <code>distance</code> 小于阈值时就可以判定为相似，大于阈值时判定为不相似，这个也是需要根据具体的业务自己去处理。</p><h2 id=结语>结语</h2><p>本文讲述了以图搜图系统进行工程实践时比较常见的内容，最后强烈推荐一下 <a href=https://milvus.io/cn/ target=_blank rel="noopener noreffer">Milvus</a> 。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-27</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://rifewang.github.io/image-search-system2/ data-title=以图搜图系统工程实践 data-hashtags=Engineering><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://rifewang.github.io/image-search-system2/ data-hashtag=Engineering><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://rifewang.github.io/image-search-system2/ data-title=以图搜图系统工程实践><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://rifewang.github.io/image-search-system2/ data-title=以图搜图系统工程实践><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://rifewang.github.io/image-search-system2/ data-title=以图搜图系统工程实践><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/engineering/>Engineering</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/image-search-system/ class=prev rel=prev title=以图搜图系统概述><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>以图搜图系统概述</a>
<a href=/image-search-total/ class=next rel=next title=又拍图片管家亿级图像之搜图系统的两代演进及底层原理>又拍图片管家亿级图像之搜图系统的两代演进及底层原理<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>凌虚</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>