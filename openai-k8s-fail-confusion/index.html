<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>我对 OpenAI Kubernetes 集群故障的追问与疑惑 - 凌虚 Blog</title><meta name=Description content="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><meta property="og:url" content="https://rifewang.github.io/openai-k8s-fail-confusion/">
<meta property="og:site_name" content="凌虚 Blog"><meta property="og:title" content="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><meta property="og:description" content="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-19T15:06:08+08:00"><meta property="article:modified_time" content="2024-12-19T17:23:03+08:00"><meta property="article:tag" content="Kubernetes"><meta property="og:image" content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:title content="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><meta name=twitter:description content="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><meta name=application-name content="凌虚的博客"><meta name=apple-mobile-web-app-title content="凌虚的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://rifewang.github.io/openai-k8s-fail-confusion/><link rel=prev href=https://rifewang.github.io/component-optimize/><link rel=next href=https://rifewang.github.io/k8s-apf/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"我对 OpenAI Kubernetes 集群故障的追问与疑惑","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rifewang.github.io\/openai-k8s-fail-confusion\/"},"image":["https:\/\/rifewang.github.io\/images\/avatar.png"],"genre":"posts","keywords":"Kubernetes","wordcount":1469,"url":"https:\/\/rifewang.github.io\/openai-k8s-fail-confusion\/","datePublished":"2024-12-19T15:06:08+08:00","dateModified":"2024-12-19T17:23:03+08:00","license":"Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)","publisher":{"@type":"Organization","name":"凌虚","logo":"https:\/\/rifewang.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"凌虚"},"description":"我对 OpenAI Kubernetes 集群故障的追问与疑惑"}</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-VRMQFEVL7J"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VRMQFEVL7J")</script><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about>作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about title>作者</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">我对 OpenAI Kubernetes 集群故障的追问与疑惑</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>凌虚</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>Kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-12-19>2024-12-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1469 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;3 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#故障复盘>故障复盘</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><p>2024 年 12 月 11 号，<code>OpenAI</code> 的 <code>Kubernetes</code> 集群发生故障，<code>API</code>、<code>ChatGPT</code>、<code>Sora</code> 等服务都受到了影响，且时间长达 4 小时 22 分钟。</p><p>关于这次故障，官方有公开复盘，也有很多媒体博主追踪报导。然而，我对此并不满意，<strong>本文我将会提出自己的疑惑与追问</strong>。</p><h2 id=故障复盘>故障复盘</h2><blockquote><p>At 3:12 PM PST, we deployed a new telemetry service to collect detailed Kubernetes control plane metrics.</p></blockquote><blockquote><p>Telemetry services have a very wide footprint, so this new service’s configuration unintentionally caused every node in each cluster to execute resource-intensive Kubernetes API operations whose cost scaled with the size of the cluster. With thousands of nodes performing these operations simultaneously, the Kubernetes API servers became overwhelmed, taking down the Kubernetes control plane in most of our large clusters. This issue was most pronounced in our largest clusters, so our testing didn’t catch it – and DNS caching made the issue far less visible until the rollouts had begun fleet-wide.</p></blockquote><blockquote><p>The Kubernetes data plane can operate largely independently of the control plane, but DNS relies on the control plane – services don’t know how to contact one another without the Kubernetes control plane.</p></blockquote><blockquote><p>In short, the root cause was a new telemetry service configuration that unexpectedly generated massive Kubernetes API load across large clusters, overwhelming the control plane and breaking DNS-based service discovery.</p></blockquote><p>根据以上官方信息所述，故障的根本原因在于新部署了一个 telemetry 服务，这个服务的本意是收集详细的控制平面的指标，却意外地导致集群中的每个 <code>node</code> 节点都执行了资源密集型的 <code>Kubernetes API</code> 操作，集群中的 <code>node</code> 节点数量越多，对 <code>kube-apiserver</code> 的冲击越大，最终导致 <code>kube-apiserver</code> 瘫痪。</p><p>对此，我的疑问是：</p><ul><li><strong>telemetry 服务到底做了什么会导致 node 节点更频繁的调用了 kube-apiserver ？</strong></li><li><strong>telemetry 服务的本意是收集 control plane 控制平面的指标，为什么会牵扯到 node 节点？</strong></li></ul><p>node 节点只是一个范围，真正执行操作的应该是节点上的某个组件，比如 <code>kubelet</code>、<code>kube-proxy</code>、<code>CNI</code>、<code>Pod/Container</code>。</p><ul><li><strong>到底是哪个/哪些具体的组件执行了更加频繁的对 kube-apiserver 的操作？</strong></li></ul><p>集群内的服务使用了 <code>DNS-based service discovery</code>，DNS 在缓存失效后需要与 <code>kube-apiserver</code> 交互，而后者已经瘫痪，因此集群内的服务通信异常，而这种异常也很容易辨别（集群内部域名无法解析），所以也能很快地定位到故障。</p><blockquote><p>DNS caching mitigated the impact temporarily by providing stale but functional DNS records. However, as cached records expired over the following 20 minutes, services began failing due to their reliance on real-time DNS resolution. This timing was critical because it delayed the visibility of the issue, allowing the rollout to continue before the full scope of the problem was understood. Once the DNS caches were empty, the load on the DNS servers was multiplied, adding further load to the control plane and further complicating immediate mitigation.</p></blockquote><p>再看故障分析里对 DNS 的描述，由于 DNS 存在缓存，它延迟了问题的显现，所以工程师刚开始没发现问题，继续推进了部署工作。而在 DNS 缓存失效后，控制平面 <code>kube-apiserver</code> 的负载又被加大。</p><p>DNS 存在缓存机制这点应该是一种常识，部署的时候忽略了也可以理解，但是：</p><ul><li><strong>DNS 不应该背锅，机制就是这样，怎么使用和配置完全是工程师的职责。</strong></li><li><strong>等到 DNS 挂了才发现问题就有点晚了，既然知道部署的新服务与控制平面交互，那么对控制平面的监控呢？</strong></li></ul><blockquote><p>In order to make that fix, we needed to access the Kubernetes control plane – which we could not do due to the increased load to the Kubernetes API servers.</p></blockquote><p>为了修复问题，需要访问 kube-apiserver，但是后者挂掉了因此无法做到。</p><p>听上去有些道理，但是 <code>kube-apiserver</code> 专门提供了 <code>--max-requests-inflight</code> 和 <code>--max-mutation-requests-inflight</code> 两个参数用于设置最大并发请求数。<strong>工程师对此一无所知吗？</strong></p><p>另外，<code>kube-apiserver</code> 还提供了 <code>APF</code>（<code>API Priority and Fairness</code>）机制，用来划分请求的优先级，保障集群管理员在过载的情况下仍然能够控制 <code>kube-apiserver</code>。</p><blockquote><p>We do not yet have a mechanism to ensure access to the API server when the data plane is putting too much pressure on the control plane. We’ll implement break-glass mechanisms to ensure that engineers can access Kubernetes API servers in any circumstances.</p></blockquote><p>然而，从披露的信息看，<strong>OpenAI 的工程师似乎之前对这些缺乏深入了解，是使用的 kubernetes 版本过于老旧，还是基于 kubernetes 魔改了很多东西？</strong></p><p><strong>他们说的 <code>break-glass</code> 机制又是什么？这不就是 <code>APF</code> 干的事情吗？</strong></p><p>我对 OpenAI Kubernetes 集群故障的疑惑很多，但是这些细节恐怕只有他们内部工程师知道了。</p><h2 id=总结>总结</h2><p><code>kube-apiserver</code> 是一个非常重要的组件，不只是文中提到的 DNS 服务会与它交互，因此对集群的监控一定要额外注意它。另外很多组件的数据存储除了支持 <code>kubernetes API</code> 之外，还可以直连 <code>etcd</code>，因此做高可用的时候，也可以考虑让组件使用另外的 <code>etcd</code>，从而减小对控制平面的依赖。</p><hr><p>(我是凌虚，关注我，无广告，专注技术，欢迎交流或为我推荐工作)</p><hr><p>参考资料：</p><ul><li><em><a href=https://status.openai.com/incidents/ctrsv3lwd797 target=_blank rel="noopener noreffer">https://status.openai.com/incidents/ctrsv3lwd797</a></em></li><li><em><a href=https://kubernetes.io/docs/concepts/cluster-administration/flow-control/ target=_blank rel="noopener noreffer">https://kubernetes.io/docs/concepts/cluster-administration/flow-control/</a></em></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-12-19</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://rifewang.github.io/openai-k8s-fail-confusion/ data-title="我对 OpenAI Kubernetes 集群故障的追问与疑惑" data-hashtags=Kubernetes><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://rifewang.github.io/openai-k8s-fail-confusion/ data-hashtag=Kubernetes><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://rifewang.github.io/openai-k8s-fail-confusion/ data-title="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://rifewang.github.io/openai-k8s-fail-confusion/ data-title="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://rifewang.github.io/openai-k8s-fail-confusion/ data-title="我对 OpenAI Kubernetes 集群故障的追问与疑惑"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/kubernetes/>Kubernetes</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/component-optimize/ class=prev rel=prev title=系统组件优化的思考框架><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>系统组件优化的思考框架</a>
<a href=/k8s-apf/ class=next rel=next title="Kubernetes APF（API 优先级和公平调度）简介">Kubernetes APF（API 优先级和公平调度）简介<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>凌虚</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>