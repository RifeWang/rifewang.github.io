<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>web 安全之 Clickjacking - 凌虚 Blog</title><meta name=Description content="web 安全之 Clickjacking ( UI redressing )"><meta property="og:title" content="web 安全之 Clickjacking">
<meta property="og:description" content="web 安全之 Clickjacking ( UI redressing )"><meta property="og:type" content="article"><meta property="og:url" content="https://rifewang.github.io/translation/web-security/clickjacking/clickjacking/"><meta property="og:image" content="https://rifewang.github.io/images/avatar.png"><meta property="article:section" content="translation"><meta property="article:published_time" content="2021-03-05T00:00:00+08:00"><meta property="article:modified_time" content="2023-02-21T11:33:46+08:00"><meta property="og:site_name" content="凌虚 Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rifewang.github.io/images/avatar.png"><meta name=twitter:title content="web 安全之 Clickjacking"><meta name=twitter:description content="web 安全之 Clickjacking ( UI redressing )"><meta name=application-name content="凌虚的博客"><meta name=apple-mobile-web-app-title content="凌虚的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=canonical href=https://rifewang.github.io/translation/web-security/clickjacking/clickjacking/><link rel=prev href=https://rifewang.github.io/translation/web-security/request-smuggling/http-request-smuggling/><link rel=next href=https://rifewang.github.io/translation/web-security/http-host-header-attacks/password-reset-poisoning/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"web 安全之 Clickjacking","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rifewang.github.io\/translation\/web-security\/clickjacking\/clickjacking\/"},"image":["https:\/\/rifewang.github.io\/images\/avatar.png"],"genre":"translation","wordcount":2335,"url":"https:\/\/rifewang.github.io\/translation\/web-security\/clickjacking\/clickjacking\/","datePublished":"2021-03-05T00:00:00+08:00","dateModified":"2023-02-21T11:33:46+08:00","license":"Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)","publisher":{"@type":"Organization","name":"凌虚","logo":"https:\/\/rifewang.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"凌虚"},"description":"web 安全之 Clickjacking ( UI redressing )"}</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-VRMQFEVL7J"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VRMQFEVL7J")</script><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"light"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"light"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="凌虚 Blog">凌虚的博客</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="page single special"><h1 class="single-title animate__animated animate__pulse animate__faster">web 安全之 Clickjacking</h1><div class=content id=content><h1 id=clickjacking--ui-redressing->Clickjacking ( UI redressing )</h1><p>在本节中，我们将解释什么是 clickjacking 点击劫持，并描述常见的点击劫持攻击示例，以及讨论如何防御这些攻击。</p><h2 id=什么是点击劫持>什么是点击劫持</h2><p>点击劫持是一种基于界面的攻击，通过诱导用户点击钓鱼网站中的被隐藏了的可操作的危险内容。</p><p>例如：某个用户被诱导访问了一个钓鱼网站（可能是点击了电子邮件中的链接），然后点击了一个赢取大奖的按钮。实际情况则是，攻击者在这个赢取大奖的按钮下面隐藏了另一个网站上向其他账户进行支付的按钮，而结果就是用户被诱骗进行了支付。这就是一个点击劫持攻击的例子。这项技术实际上就是通过 <code>iframe</code> 合并两个页面，真实操作的页面被隐藏，而诱骗用户点击的页面则显示出来。点击劫持攻击与 <code>CSRF</code> 攻击的不同之处在于，点击劫持需要用户执行某种操作，比如点击按钮，而 <code>CSRF</code> 则是在用户不知情或者没有输入的情况下伪造整个请求。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/RifeWang/images/master/web-security/clickjacking.png data-srcset="https://raw.githubusercontent.com/RifeWang/images/master/web-security/clickjacking.png, https://raw.githubusercontent.com/RifeWang/images/master/web-security/clickjacking.png 1.5x, https://raw.githubusercontent.com/RifeWang/images/master/web-security/clickjacking.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/RifeWang/images/master/web-security/clickjacking.png title=clickjacking></p><p>针对 <code>CSRF</code> 攻击的防御措施通常是使用 <code>CSRF token</code>（针对特定会话、一次性使用的随机数）。而点击劫持无法则通过 <code>CSRF token</code> 缓解攻击，因为目标会话是在真实网站加载的内容中建立的，并且所有请求均在域内发生。<code>CSRF token</code> 也会被放入请求中，并作为正常行为的一部分传递给服务器，与普通会话相比，差异就在于该过程发生在隐藏的 <code>iframe</code> 中。</p><h2 id=如何构造一个基本的点击劫持攻击>如何构造一个基本的点击劫持攻击</h2><p>点击劫持攻击使用 CSS 创建和操作图层。攻击者将目标网站通过 <code>iframe</code> 嵌入并隐藏。使用样式标签和参数的示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;head&gt;
</span></span><span class=line><span class=cl>  &lt;style&gt;
</span></span><span class=line><span class=cl>    #target_website {
</span></span><span class=line><span class=cl>      position:relative;
</span></span><span class=line><span class=cl>      width:128px;
</span></span><span class=line><span class=cl>      height:128px;
</span></span><span class=line><span class=cl>      opacity:0.00001;
</span></span><span class=line><span class=cl>      z-index:2;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>    #decoy_website {
</span></span><span class=line><span class=cl>      position:absolute;
</span></span><span class=line><span class=cl>      width:300px;
</span></span><span class=line><span class=cl>      height:400px;
</span></span><span class=line><span class=cl>      z-index:1;
</span></span><span class=line><span class=cl>      }
</span></span><span class=line><span class=cl>  &lt;/style&gt;
</span></span><span class=line><span class=cl>&lt;/head&gt;
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>&lt;body&gt;
</span></span><span class=line><span class=cl>  &lt;div id=&#34;decoy_website&#34;&gt;
</span></span><span class=line><span class=cl>  ...decoy web content here...
</span></span><span class=line><span class=cl>  &lt;/div&gt;
</span></span><span class=line><span class=cl>  &lt;iframe id=&#34;target_website&#34; src=&#34;https://vulnerable-website.com&#34;&gt;
</span></span><span class=line><span class=cl>  &lt;/iframe&gt;
</span></span><span class=line><span class=cl>&lt;/body&gt;
</span></span></code></pre></td></tr></table></div></div><p>目标网站 <code>iframe</code> 被定位在浏览器中，使用适当的宽度和高度位置值将目标动作与诱饵网站精确重叠。无论屏幕大小，浏览器类型和平台如何，绝对位置值和相对位置值均用于确保目标网站准确地与诱饵重叠。<code>z-index</code> 决定了 <code>iframe</code> 和网站图层的堆叠顺序。透明度被设置为零，因此 <code>iframe</code> 内容对用户是透明的。浏览器可能会基于 <code>iframe</code> 透明度进行阈值判断从而自动进行点击劫持保护（例如，Chrome 76 包含此行为，但 Firefox 没有），但攻击者仍然可以选择适当的透明度值，以便在不触发此保护行为的情况下获得所需的效果。</p><h2 id=预填写输入表单>预填写输入表单</h2><p>一些需要表单填写和提交的网站允许在提交之前使用 GET 参数预先填充表单输入。由于 GET 参数在 URL 中，那么攻击者可以直接修改目标 URL 的值，并将透明的“提交”按钮覆盖在诱饵网站上。</p><h2 id=frame-拦截脚本>Frame 拦截脚本</h2><p>只要网站可以被 <code>frame</code> ，那么点击劫持就有可能发生。因此，预防性技术的基础就是限制网站 <code>frame</code> 的能力。比较常见的客户端保护措施就是使用 web 浏览器的 <code>frame</code> 拦截或清理脚本，比如浏览器的插件或扩展程序，这些脚本通常是精心设计的，以便执行以下部分或全部行为：</p><ul><li>检查并强制当前窗口是主窗口或顶部窗口</li><li>使所有 <code>frame</code> 可见。</li><li>阻止点击可不见的 <code>frame</code>。</li><li>拦截并标记对用户的潜在点击劫持攻击。</li></ul><p>Frame 拦截技术一般特定于浏览器和平台，且由于 HTML 的灵活性，它们通常也可以被攻击者规避。由于这些脚本也是 JavaScript ，浏览器的安全设置也可能会阻止它们的运行，甚至浏览器直接不支持 JavaScript 。攻击者也可以使用 HTML5 <code>iframe</code> 的 <code>sandbox</code> 属性去规避 frame 拦截。当 <code>iframe</code> 的 <code>sandbox</code> 设置为 <code>allow-forms</code> 或 <code>allow-scripts</code>，且 <code>allow-top-navigation</code> 被忽略时，frame 拦截脚本可能就不起作用了，因为 iframe 无法检查它是否是顶部窗口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;iframe id=&#34;victim_website&#34; src=&#34;https://victim-website.com&#34; sandbox=&#34;allow-forms&#34;&gt;&lt;/iframe&gt;
</span></span></code></pre></td></tr></table></div></div><p>当 <code>iframe</code> 的 <code>allow-forms</code> 和 <code>allow-scripts</code> 被设置，且 top-level 导航被禁用，这会抑制 frame 拦截行为，同时允许目标站内的功能。</p><h2 id=结合使用点击劫持与-dom-xss-攻击>结合使用点击劫持与 DOM XSS 攻击</h2><p>到目前为止，我们把点击劫持看作是一种独立的攻击。从历史上看，点击劫持被用来执行诸如在 Facebook 页面上增加“点赞”之类的行为。然而，当点击劫持被用作另一种攻击的载体，如 DOM XSS 攻击，才能发挥其真正的破坏性。假设攻击者首先发现了 XSS 攻击的漏洞，则实施这种组合攻击就很简单了，只需要将 <code>iframe</code> 的目标 URL 结合 XSS ，以使用户点击按钮或链接，从而执行 DOM XSS 攻击。</p><h2 id=多步骤点击劫持>多步骤点击劫持</h2><p>攻击者操作目标网站的输入可能需要执行多个操作。例如，攻击者可能希望诱骗用户从零售网站购买商品，而在下单之前还需要将商品添加到购物篮中。为了实现这些操作，攻击者可能使用多个视图或 <code>iframe</code> ，这也需要相当的精确性，攻击者必须非常小心。</p><h2 id=如何防御点击劫持攻击>如何防御点击劫持攻击</h2><p>我们在上文中已经讨论了一种浏览器端的预防机制，即 frame 拦截脚本。然而，攻击者通常也很容易绕过这种防御。因此，服务端驱动的协议被设计了出来，以限制浏览器 <code>iframe</code> 的使用并减轻点击劫持的风险。</p><p>点击劫持是一种浏览器端的行为，它的成功与否取决于浏览器的功能以及是否遵守现行 web 标准和最佳实践。服务端的防御措施就是定义 <code>iframe</code> 组件使用的约束，然而，其实现仍然取决于浏览器是否遵守并强制执行这些约束。服务端针对点击劫持的两种保护机制分别是 <code>X-Frame-Options</code> 和 <code>Content Security Policy</code> 。</p><h2 id=x-frame-options>X-Frame-Options</h2><p><code>X-Frame-Options</code> 最初由 IE8 作为非官方的响应头引入，随后也在其他浏览器中被迅速采用。<code>X-Frame-Options</code> 头为网站所有者提供了对 <code>iframe</code> 使用的控制（就是说第三方网站不能随意的使用 <code>iframe</code> 嵌入你控制的网站），比如你可以使用 <code>deny</code> 直接拒绝所有 <code>iframe</code> 引用你的网站：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>X-Frame-Options: deny
</span></span></code></pre></td></tr></table></div></div><p>或者使用 <code>sameorigin</code> 限制为只有同源网站可以引用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>X-Frame-Options: sameorigin
</span></span></code></pre></td></tr></table></div></div><p>或者使用 <code>allow-from</code> 指定白名单：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>X-Frame-Options: allow-from https://normal-website.com
</span></span></code></pre></td></tr></table></div></div><p><code>X-Frame-Options</code> 在不同浏览器中的实现并不一致（比如，Chrome 76 或 Safari 12 不支持 <code>allow-from</code>）。然而，作为多层防御策略中的一部分，其与 <code>Content Security Policy</code> 结合使用时，可以有效地防止点击劫持攻击。</p><h2 id=content-security-policy>Content Security Policy</h2><p><code>Content Security Policy</code> (<code>CSP</code>) 内容安全策略是一种检测和预防机制，可以缓解 XSS 和点击劫持等攻击。<code>CSP</code> 通常是由 web 服务作为响应头返回，格式为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Content-Security-Policy: policy
</span></span></code></pre></td></tr></table></div></div><p>其中的 <code>policy</code> 是一个由分号分隔的策略指令字符串。<code>CSP</code> 向客户端浏览器提供有关允许的 Web 资源来源的信息，浏览器可以将这些资源应用于检测和拦截恶意行为。</p><p>有关点击劫持的防御，建议在 <code>Content-Security-Policy</code> 中增加 <code>frame-ancestors</code> 策略。</p><ul><li><code>frame-ancestors 'none'</code> 类似于 <code>X-Frame-Options: deny</code> ，表示拒绝所有 iframe 引用。</li><li><code>frame-ancestors 'self'</code> 类似于 <code>X-Frame-Options: sameorigin</code> ，表示只允许同源引用。</li></ul><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Content-Security-Policy: frame-ancestors &#39;self&#39;;
</span></span></code></pre></td></tr></table></div></div><p>或者指定网站白名单：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Content-Security-Policy: frame-ancestors normal-website.com;
</span></span></code></pre></td></tr></table></div></div><p>为了有效地防御点击劫持和 XSS 攻击，<code>CSP</code> 需要进行仔细的开发、实施和测试，并且应该作为多层防御策略中的一部分使用。</p></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2017 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>凌虚</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>